#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔎 pre-push: typecheck + quick tests"

# 1) เช็ค TypeScript ให้ไว (ไม่ build)
yarn typecheck || exit 1

# 2) รันทดสอบแบบเร็ว:
# - ถ้ามีฐานเทียบ origin/main จะทดสอบเฉพาะที่เปลี่ยน (--changedSince)
# - ถ้าไม่มี ก็รันทั้งชุดแบบ bail เพื่อตกทันทีที่เจอ fail
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  BASE=$(git merge-base HEAD origin/main)
  yarn test --config jest.config.ts --passWithNoTests --bail --changedSince="$BASE" --maxWorkers=50% || exit 1
else
  yarn test --config jest.config.ts --passWithNoTests --bail --maxWorkers=50% || exit 1
fi
