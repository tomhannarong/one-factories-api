#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ”Ž pre-push: typecheck + quick tests"

# 1) à¹€à¸Šà¹‡à¸„ TypeScript à¹ƒà¸«à¹‰à¹„à¸§ (à¹„à¸¡à¹ˆ build)
yarn typecheck || exit 1

# 2) à¸£à¸±à¸™à¸—à¸”à¸ªà¸­à¸šà¹à¸šà¸šà¹€à¸£à¹‡à¸§:
# - à¸–à¹‰à¸²à¸¡à¸µà¸à¸²à¸™à¹€à¸—à¸µà¸¢à¸š origin/main à¸ˆà¸°à¸—à¸”à¸ªà¸­à¸šà¹€à¸‰à¸žà¸²à¸°à¸—à¸µà¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ (--changedSince)
# - à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µ à¸à¹‡à¸£à¸±à¸™à¸—à¸±à¹‰à¸‡à¸Šà¸¸à¸”à¹à¸šà¸š bail à¹€à¸žà¸·à¹ˆà¸­à¸•à¸à¸—à¸±à¸™à¸—à¸µà¸—à¸µà¹ˆà¹€à¸ˆà¸­ fail
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  BASE=$(git merge-base HEAD origin/main)
  yarn test --config jest.config.ts --passWithNoTests --bail --changedSince="$BASE" --maxWorkers=50% || exit 1
else
  yarn test --config jest.config.ts --passWithNoTests --bail --maxWorkers=50% || exit 1
fi
